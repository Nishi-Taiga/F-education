# データ移行スクリプト

このディレクトリには、Replitアプリケーションから Vercel + Supabase 環境へのデータ移行を簡単にするためのスクリプトが含まれています。

## 使い方

### 1. データのエクスポート

まず、現在のReplitアプリケーションからデータをエクスポートします：

```bash
# Replitのアプリケーション内で実行
npm install -g tsx
npx tsx scripts/migration/export-data.ts
```

このスクリプトは、現在のReplitデータベースからすべてのデータをJSONファイルとして `data` ディレクトリに保存します。

### 2. ユーザーの移行

次に、SupabaseのAuth機能を使用してユーザーを移行します：

```bash
# 新しいVercel環境で実行
npx tsx scripts/migration/import-users.ts
```

このスクリプトは、エクスポートされたユーザーデータを使用して、Supabase Authにユーザーを作成し、データベースにユーザー情報を挿入します。

### 3. その他のデータのインポート

最後に、残りのデータをSupabaseデータベースにインポートします：

```bash
# 新しいVercel環境で実行
npx tsx scripts/migration/import-data.ts
```

このスクリプトは、エクスポートされた各種データを新しいSupabaseデータベースにインポートします。

## 注意事項

- エクスポート/インポートの前に、適切な環境変数が設定されていることを確認してください。
- ユーザーパスワードの扱いには特に注意してください。現在のスクリプトでは、デフォルトのパスワードを設定しています。
- 大量のデータを扱う場合は、バッチ処理を検討してください。
- 本番環境への移行前に、必ずテスト環境で動作確認を行ってください。

## 必要な環境変数

### エクスポート用（Replit環境）

```
REPLIT_DATABASE_URL=postgres://...
```

### インポート用（Vercel/Supabase環境）

```
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJh...
SUPABASE_SERVICE_ROLE_KEY=eyJh... # 管理者権限が必要
DATABASE_URL=postgresql://postgres:password@db.your-project.supabase.co:5432/postgres
```

## データ移行フロー

1. **エクスポート**：Replitの既存データベースから各テーブルのデータをJSONファイルとして抽出
2. **ユーザー移行**：Supabase Authシステムにユーザーを作成し、データベースにユーザー情報を挿入
3. **データインポート**：残りのデータ（生徒、講師、予約など）を新しいデータベースに挿入

## トラブルシューティング

### エクスポートの問題

- **接続エラー**: Replitデータベースの接続文字列が正しいことを確認
- **権限エラー**: データベースユーザーに十分な権限があることを確認

### インポートの問題

- **重複キーエラー**: 既存のデータとの競合がないか確認
- **外部キー制約エラー**: 正しい順序でデータをインポートしていることを確認（例：ユーザー→生徒→予約）

### Supabase Auth関連の問題

- **ユーザー作成エラー**: 既にメールアドレスが使用されていないか確認
- **サービスロールキーの問題**: 管理者権限を持つサービスロールキーを使用していることを確認

## 移行後の確認事項

1. **ユーザーログイン**: すべてのユーザーが正常にログインできるか確認
2. **データの整合性**: すべてのデータが正しく移行されたか確認
3. **サービス機能**: 予約、チケット購入、レポート機能などが正常に動作するか確認

## セキュリティ上の注意事項

- 移行プロセス中に生成されたJSONファイルには機密情報が含まれる可能性があります。移行完了後は安全に削除するか、適切に保護してください。
- 本番環境への移行前に、テスト環境で十分なテストを行ってください。
- 実際の運用では、パスワードリセットまたは初回ログイン時のパスワード設定を促すことを推奨します。

## 追加リソース

- [Supabase Auth ドキュメント](https://supabase.com/docs/guides/auth)
- [Drizzle ORM ドキュメント](https://orm.drizzle.team/docs/overview)
- [Vercel デプロイメントガイド](https://vercel.com/docs/deployments/overview)
