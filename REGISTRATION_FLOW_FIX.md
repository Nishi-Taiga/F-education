# ユーザー登録・認証フローの修正

## 課題と問題点

新規登録プロセスにおいて、以下の問題が発生していました：

1. Supabase Authenticationには新規ユーザーが作成されていたが、アプリケーションのデータベース（`users`テーブル）にユーザーレコードが正しく作成されていなかった
2. スキーマ互換性の問題：`first_name`, `last_name`, `auth_id` など存在しないカラムに対する参照があった
3. 認証後のナビゲーションフローに問題があり、プロフィール設定画面に適切に誘導されていなかった

## 修正の概要

以下の改善を行いました：

### 1. ユーザー登録プロセスの改善

- 登録フローを分離：
  - 初回：メールアドレスとパスワードのみでユーザーを作成し、認証メールを送信
  - 認証後：プロフィール設定画面に誘導し、詳細情報を登録

- 過度な情報入力を排除：
  - 初回登録時には最小限の情報のみを要求
  - プロフィール設定画面で詳細情報を入力

### 2. スキーマとの互換性確保

- 実際の `users` テーブルのスキーマに合わせたデータ構造の使用
- 存在しないカラムへの参照を削除：
  - `first_name`, `last_name` → `display_name` を使用
  - `auth_id` カラムの参照を削除

### 3. ミドルウェアによるナビゲーション制御

- 認証状態に基づくページ遷移の制御を強化
- プロフィール未設定ユーザーを自動的にプロフィール設定ページに誘導
- 認証済みユーザーが認証関連ページにアクセスした場合のリダイレクト処理

### 4. エラーハンドリングの向上

- 詳細なエラーメッセージ表示
- Supabase操作時の例外処理の強化
- デバッグ用のコンソールログ出力の追加

## 修正されたファイル

1. `hooks/use-auth.tsx` - 認証フックの改善
2. `middleware.ts` - ナビゲーション制御の強化
3. `app/profile-setup/parent/page.tsx` - 保護者プロフィール設定画面の修正
4. `app/profile-setup/tutor/page.tsx` - 講師プロフィール設定画面の修正

## 登録フローの概要

修正後の新規登録フローは以下のようになりました：

1. ユーザーが新規登録画面でメールアドレスとパスワードを入力
2. Supabase Authenticationにユーザーが作成され、確認メールが送信
3. ユーザーがメール内のリンクをクリックして認証を完了
4. ミドルウェアが認証状態を確認し、プロフィール設定画面に誘導
5. ユーザーが保護者または講師としてプロフィール情報を入力
6. プロフィール情報が対応するテーブル（`users`および`students`/`tutors`）に保存
7. プロフィール設定完了後、ダッシュボードに遷移

## 今後の改善点

1. データ整合性の強化：
   - 認証情報とユーザー情報の紐付けをより堅牢に
   - トランザクション的なアプローチでデータの整合性を確保

2. スキーマの最適化：
   - 将来的に必要に応じて `auth_id` カラムを追加
   - 統一的なデータモデルの設計

3. UX/UIの改善：
   - 認証状態のよりわかりやすい表示
   - プロフィール設定プロセスのステップ表示

## 将来的な検討事項

- より詳細なプロフィール情報の段階的収集
- OAuth認証の追加（Google、Appleなど）
- 2要素認証の実装
- より細かいロールベースのアクセス制御