# ログイン認証の修正について

## 問題の内容

ログイン認証で以下のエラーが発生していました：
```
column users.user_id does not exit
```

## 原因

Replitからの移行時に、データベーススキーマの違いにより、認証処理が正しく機能していませんでした。具体的には：

1. 元の認証システムでは、ユーザーを `users` テーブルの `user_id` カラムで識別していた
2. Supabase認証システムでは、認証情報と `users` テーブルを紐づける必要がある
3. 移行したデータベースには `user_id` カラムが存在しなかった

## 修正内容

以下の修正を行いました：

1. **認証情報の紐づけ方法の変更**
   - `user_id` ではなく `email` を使用してユーザーを識別するように変更
   - Supabaseの認証情報と既存データを `email` で紐づけるため、認証コードを修正

2. **AuthContextの更新**
   - `user_id` への参照を修正し、Supabase認証IDを `auth_id` として扱うように変更
   - ユーザーオブジェクトの構造を実際のデータベーススキーマに合わせて調整

3. **API Route の更新**
   - `/api/user/me` および `/api/user` エンドポイントを更新
   - `user_id` ではなく `email` でユーザーを検索するよう修正
   - レスポンスフォーマットを新しいユーザーオブジェクト構造に合わせて調整

## 今後について

現在のデータベース構造では、Supabaseの認証IDとユーザーテーブルの紐づけは `email` 経由で行われています。より強固な設計とするためには、将来的に以下の点を検討することをお勧めします：

1. `users` テーブルに `auth_id` カラムを追加し、Supabaseの認証IDを直接保存する
2. ユーザーの一意性を担保するために、`auth_id` カラムにUNIQUE制約を設定する
3. email変更に対応するための追加ロジックを実装する

これらの対応は今後のアップデートで計画的に行うことをおすすめします。