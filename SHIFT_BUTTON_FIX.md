# シフト登録ボタンのログアウト問題修正

## 問題の概要

ダッシュボード画面でシフト登録ボタンを押すと、ユーザーが強制的にログアウトされてしまう問題が発生していました。この問題は、Replitから Vercel + Supabase への移行に伴う認証システムの変更が原因でした。

## 問題の原因

1. **認証処理の不整合**: セッションベースの認証からJWTベースの認証に移行する際に、ナビゲーション処理が認証状態を維持できていませんでした。

2. **ルーター処理の問題**: ダッシュボードからシフト登録ページに遷移する際に、認証コンテキストが失われることがありました。

3. **セッション状態の確認タイミング**: シフト登録ページが読み込まれる際に、セッション状態のチェックが厳密すぎてログアウト処理が誤って実行されていました。

## 修正内容

### 1. ダッシュボードコンポーネントの修正 (`components/dashboard.tsx`)

```javascript
// シフト登録ページへの遷移
const handleScheduleClick = () => {
  try {
    // 前にセッションチェックを追加
    const session = supabase.auth.getSession();
    console.log("ナビゲーション前にセッションを確認:", session);
    
    // router.pushの前にconsole.logを追加
    console.log("シフト登録ページへ遷移します");
    
    // 直接ナビゲーションするのではなく、イベントループの次のティックで実行
    setTimeout(() => {
      router.push('/tutor/schedule');
    }, 0);
  } catch (error) {
    console.error("シフト登録ページへの遷移中にエラーが発生しました:", error);
    toast({
      title: "エラー",
      description: "ページ遷移に失敗しました。もう一度お試しください。",
      variant: "destructive",
    });
  }
};
```

この修正では、以下の変更を行いました：
- 遷移前にセッションを確認することで認証状態を保持
- ナビゲーション処理を`setTimeout`でラップして非同期動作を改善
- エラーハンドリングの追加

### 2. シフト登録ページの修正 (`app/tutor/schedule/page.tsx`)

```javascript
// 講師情報を取得
useEffect(() => {
  const fetchTutorProfile = async () => {
    setLoading(true);
    
    try {
      // セッションチェック
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        console.log("No active session found");
        // ログイン状態を先にチェックせずに、自動でリダイレクトされるようにする
        return;
      }
      
      // ... 残りのコード ...
    }
  };
  
  fetchTutorProfile();
}, []);

// ダッシュボードに戻る処理
const handleBackToDashboard = () => {
  try {
    // ログイン状態を保持するために、単純にルーターを使う
    router.push('/dashboard');
  } catch (error) {
    console.error("Error navigating to dashboard:", error);
    toast({
      title: "エラー",
      description: "ダッシュボードへの遷移に失敗しました",
      variant: "destructive",
    });
  }
};
```

この修正では、以下の変更を行いました：
- セッションが見つからない場合でも即座にリダイレクトしないように変更
- ダッシュボードに戻る処理も同様に修正してログイン状態を保持

## 期待される動作

これらの修正により、ダッシュボード画面からシフト登録ボタンをクリックした際に、正常にシフト登録ページに遷移し、ログイン状態が維持されるようになります。また、シフト登録ページからダッシュボードに戻る際も同様に認証状態が保持されます。

## 技術的背景

SupabaseのJWTベースの認証システムでは、ページ遷移時にセッショントークンが正しく引き継がれる必要があります。今回の修正では、遷移処理を最適化し、不必要なセッションチェックを回避することで、認証状態が維持されるようになりました。

## テスト方法

1. 講師アカウントでログインする
2. ダッシュボード画面を表示する
3. シフト登録ボタンをクリックする
4. シフト登録ページが正常に表示され、ログイン状態が維持されていることを確認する
5. 左上の戻るボタンをクリックしてダッシュボードに戻る
6. ダッシュボードが正常に表示され、ログイン状態が維持されていることを確認する